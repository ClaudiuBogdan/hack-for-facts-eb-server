---
session_id: '523dd2ea-06cd-4158-9fd2-36bb956b61f7'
session_id_source: 'provided'
created: '2026-01-14T09:08:54Z'
updated: '2026-01-15T09:28:02Z'
status: 'active'
commit: ''
topic: ''
tags: []
project_dir: '/Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-server'
cwd: '/Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-server'
---

# Session Decisions: 523dd2ea-06cd-4158-9fd2-36bb956b61f7

## Decisions

### PROMPT: User input

**Time**: 2026-01-14T09:08:54Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T090854Z-UserPrompt-34634

ultrathink I need you to have a look at the notifications layer. We need a way to send notifications to the user. So for that we have different kinds of notifications and we need to generate different messages based on the kind of notification and for that we use templates. To improve the developer experience we need a way to preview the templates but also use powerful tools for creating those templates. And then we need another mechanism to make sure the sending is independent and avoid send...

---

### USER: Email Provider

**Time**: 2026-01-14T09:16:26Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T091626Z-AskUserQuestion-65538-q1
**Context**: Email Provider
**Multi-select**: false

**Question**: Which email provider do you want to use for sending notifications?

**Options**:

1. **Resend (Recommended)** - Modern API, excellent DX, built-in analytics, React Email support
2. **SendGrid** - Enterprise-grade, extensive analytics, established provider
3. **SMTP** - Self-hosted or any SMTP server, maximum flexibility
4. **Multiple providers** - Implement all three with runtime selection

**Selected**: Resend (Recommended)

---

### USER: Templates

**Time**: 2026-01-14T09:16:26Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T091626Z-AskUserQuestion-65538-q2
**Context**: Templates
**Multi-select**: false

**Question**: What template system do you prefer for email rendering?

**Options**:

1. **MJML + Handlebars (Recommended)** - Responsive emails, powerful templating, industry standard for email
2. **React Email** - JSX-based, type-safe, great DX but requires build step
3. **Simple interpolation** - Minimal deps, {{variable}} syntax, easier to audit

**Selected**: React Email

---

### USER: Preview Tool

**Time**: 2026-01-14T09:16:26Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T091626Z-AskUserQuestion-65538-q3
**Context**: Preview Tool
**Multi-select**: false

**Question**: How do you want to preview templates during development?

**Options**:

1. **Both CLI + REST endpoint** - CLI for quick checks, REST for browser preview with hot reload
2. **CLI tool only** - Command-line preview to stdout or file
3. **REST endpoint only** - Browser-based preview at /admin/templates/preview

**Selected**: Both CLI + REST endpoint

---

### USER: Worker Mode

**Time**: 2026-01-14T09:16:26Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T091626Z-AskUserQuestion-65538-q4
**Context**: Worker Mode
**Multi-select**: false

**Question**: Should the worker run as a separate process or embedded in the main server?

**Options**:

1. **Separate process (Recommended)** - Better isolation, independent scaling, production-ready
2. **Embedded in server** - Simpler deployment, single process, good for dev/small scale

**Selected**: Separate process (Recommended)

---

### PLAN: Plan: Unified Global Settings System (URL-First, Like Language)

**Time**: 2026-01-14T12:01:18Z
**Source**: ExitPlanMode
**Score**: 4
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T120118Z-ExitPlanMode-71350-plan
**Plan created**: 2026-01-14T13:15:20Z
**Lines**: 620
**Approved in**: /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-server

**Files**:

- Original: /Users/claudiuconstantinbogdan/.claude/plans/staged-sniffing-tide.md
- Archived: .claude/plans/archived/staged-sniffing-tide-20260114T120118Z.md
- Archived (full): /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-server/.claude/plans/archived/staged-sniffing-tide-20260114T120118Z.md

**Summary**:
Based on this implementation plan, here are the 3 key decisions:

1. **Unified Resolution Priority**: Establish a strict priority chain (Forced Override > URL > Cookie > Default) that applies consistently across SSR, hydration, and client runtime. This eliminates flicker and keeps URL as shareable state while cookies remain SSR-readable persistence.

2. **Cookie-Only SSR Settings + React State for Persistence**: Split concerns—`ssrSettings` contains only cookie-derived values (not URL-mixed) to seed the hook's React state. This allows the hook to maintain live persisted preferences that survive URL clears, preventing stale fallback values after user preference changes.

3. **Block URL→Cookie Sync When Forced**: When a route constraint forces a setting (e.g., `total_euro` forces `EUR`), skip URL-to-cookie synchronization to prevent contradictory persistence. This ensures users don't get locked into wrong preferences when leaving a constrained route.

---

### IMPL: Initial task breakdown

**Time**: 2026-01-14T12:01:45Z
**Source**: TodoWrite
**Score**: 3
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T120145Z-TodoWrite-73862-tasks
**Tasks**: 19 (0 done, 1 active, 18 pending)

- [~] Install React Email and Resend dependencies
- [ ] Add BullMQ queue infrastructure in src/infra/queue/
- [ ] Add email environment variables to src/infra/config/env.ts
- [ ] Create EmailBatches table in database schema
- [ ] Extend DeliveriesRepository with new methods
- [ ] Add core types for email/job/template
- [ ] Add port interfaces (EmailProvider, EmailQueue, TemplateEngine)
- [ ] Add email/template/queue error types
- [ ] Create React Email shared components
- [ ] Create email templates for all notification types
- [ ] Create template engine adapter
- [ ] Implement Resend provider adapter
- [ ] Create email queue wrapper (BullMQ)
- [ ] Create worker entry point
- [ ] Implement triggerNewsletter use case
- [ ] Create admin routes
- [ ] Create preview CLI tool
- [ ] Wire everything in build-app.ts
- [ ] Run typecheck and fix any issues

---

### PROMPT: User input

**Time**: 2026-01-14T12:02:37Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T120237Z-UserPrompt-77582

ultrathink I need you to have a look at the notifications layer. We need a way to send notifications to the user. So for that we have different kinds of notifications and we need to generate different messages based on the kind of notification and for that we use templates. To improve the developer experience we need a way to preview the templates but also use powerful tools for creating those templates. And then we need another mechanism to make sure the sending is independent and avoid send...

---

### USER: Email Provider

**Time**: 2026-01-14T12:06:58Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T120658Z-AskUserQuestion-99369-q1
**Context**: Email Provider
**Multi-select**: false

**Question**: Which email service provider do you want to use for sending notifications?

**Options**:

1. **AWS SES** - Amazon Simple Email Service - cost-effective, high deliverability, good for scale
2. **SendGrid** - Popular API-first email service with good deliverability and analytics
3. **Resend** - Modern developer-friendly email API with React Email support
4. **Abstract interface** - Define a port/interface now, implement specific provider later

**Selected**: Resend

---

### USER: Template Engine

**Time**: 2026-01-14T12:06:58Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T120658Z-AskUserQuestion-99369-q2
**Context**: Template Engine
**Multi-select**: false

**Question**: What templating approach do you prefer for email templates?

**Options**:

1. **React Email (Recommended)** - Build emails with React components - modern DX, type-safe, preview in browser
2. **MJML + Handlebars** - MJML for responsive emails, Handlebars for variable interpolation
3. **Plain HTML + Handlebars** - Simple approach with Handlebars templates, manual responsive CSS

**Selected**: React Email (Recommended)

---

### USER: Job Processing

**Time**: 2026-01-14T12:06:58Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T120658Z-AskUserQuestion-99369-q3
**Context**: Job Processing
**Multi-select**: false

**Question**: How should notifications be scheduled and processed?

**Options**:

1. **BullMQ + Cron triggers (Recommended)** - Use existing BullMQ dependency with scheduled cron jobs for periodic newsletters
2. **External scheduler only** - External cron/Kubernetes CronJob triggers HTTP endpoint, no internal queue
3. **Real-time only** - Process notifications synchronously when triggered, no background jobs

**Selected**: BullMQ + Cron triggers (Recommended)

---

### USER: Preview Tooling

**Time**: 2026-01-14T12:06:58Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T120658Z-AskUserQuestion-99369-q4
**Context**: Preview Tooling
**Multi-select**: false

**Question**: What developer tooling do you need for template preview?

**Options**:

1. **Local dev server + REST API** - React Email dev server for visual editing + REST endpoint for programmatic preview
2. **CLI tool only** - Command-line tool to render templates with sample data
3. **REST API only** - REST endpoint to render templates with provided data, no visual tooling

**Selected**: Local dev server + REST API

---

### USER: User Emails

**Time**: 2026-01-14T12:22:30Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T122230Z-AskUserQuestion-66368-q1
**Context**: User Emails
**Multi-select**: false

**Question**: How should user email addresses be retrieved for sending notifications?

**Options**:

1. **Clerk API (Recommended)** - Fetch email from Clerk using userId - matches existing auth setup
2. **Store in user DB** - Add email column to user database, sync from Clerk on login
3. **Include in subscription** - User provides email when subscribing (allows non-authenticated subscriptions)

**Selected**: Clerk API (Recommended)

---

### USER: Email Batching

**Time**: 2026-01-14T12:22:30Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T122230Z-AskUserQuestion-66368-q2
**Context**: Email Batching
**Multi-select**: false

**Question**: Should multiple notifications for the same user be batched into a single email?

**Options**:

1. **Yes, batch per user (Recommended)** - One email with all notifications for that period - better UX, fewer emails
2. **No, separate emails** - One email per notification - simpler implementation, more emails

**Selected**: Yes, batch per user (Recommended)

---

### USER: Alert Triggers

**Time**: 2026-01-14T12:22:30Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T122230Z-AskUserQuestion-66368-q3
**Context**: Alert Triggers
**Multi-select**: false

**Question**: When should alert notifications be evaluated?

**Options**:

1. **Daily cron only** - Check alert conditions once daily at scheduled time
2. **Cron + data webhook** - Daily check plus immediate trigger when new data is imported
3. **Real-time (no cron)** - Only trigger when new data arrives via webhook/import

**Selected**: Manually trigger for now. I want to paste the secret api key in the terminal to avoid exposing user emails.

---

### PLAN: Notification Module - Complete Implementation Plan (v3)

**Time**: 2026-01-14T15:34:12Z
**Source**: ExitPlanMode
**Score**: 4
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T153412Z-ExitPlanMode-83784-plan
**Plan created**: 2026-01-14T17:31:29Z
**Lines**: 1135
**Approved in**: /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-server

**Files**:

- Original: /Users/claudiuconstantinbogdan/.claude/plans/lively-wishing-yeti.md
- Archived: .claude/plans/archived/lively-wishing-yeti-20260114T153412Z.md
- Archived (full): /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-server/.claude/plans/archived/lively-wishing-yeti-20260114T153412Z.md

**Summary**:

## Summary

This is a **complete notification delivery system** for transparenta.eu with production-grade reliability. Three key decisions drive the implementation:

1. **True Database-Level Idempotency**: Unique constraint on `delivery_key` + atomic `pending→sending` transition ensures exactly-once delivery semantics, protecting against crashes and retries.

2. **Resend + React Email + BullMQ Stack**: Resend for email delivery (with correct SDK idempotency key usage), React Email for type-safe templates, BullMQ for rate-limited background jobs (max 2 Resend requests/second).

3. **Webhook-Driven Delivery Lifecycle**: Deliveries transition through states (`pending→sending→sent→delivered`) updated by Resend webhooks (with svix-id deduplication), plus built-in recovery for stuck `sending` records older than 15 minutes.

The plan covers 11 implementation phases: schema migration, infrastructure setup, template module, delivery core logic, BullMQ workers, manual trigger endpoint, webhook ingestion, unsubscribe one-click support, stuck delivery recovery, integration wiring, and testing—plus a pre-implementation checklist covering critical gotchas (Redis maxmemory policy, Resend idempotency key placement, BullMQ prefix configuration, webhook signature verification with raw body).

---

### IMPL: Initial task breakdown

**Time**: 2026-01-14T15:35:41Z
**Source**: TodoWrite
**Score**: 3
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T153541Z-TodoWrite-92513-tasks
**Tasks**: 12 (0 done, 0 active, 12 pending)

- [ ] Install npm dependencies (resend, react-email)
- [ ] Phase 1: Database Schema Extension
- [ ] Phase 2: Infrastructure (env config, queue client, email client)
- [ ] Phase 3: Email Templates Module
- [ ] Phase 4: Notification Delivery Module (core types, ports, usecases)
- [ ] Phase 5: BullMQ Workers (collect, compose, send)
- [ ] Phase 6: Manual Trigger Endpoint
- [ ] Phase 7: Resend Webhook Ingestion
- [ ] Phase 8: Extend Unsubscribe Endpoint (one-click support)
- [ ] Phase 9: Stuck Sending Recovery
- [ ] Phase 10: Integration & Wiring in build-app.ts
- [ ] Phase 11: Testing

---

### IMPL: Added 2 new task(s)

**Time**: 2026-01-14T19:37:43Z
**Source**: TodoWrite
**Score**: 3
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T193743Z-TodoWrite-36032-tasks
**Tasks**: 14 (11 done, 1 active, 2 pending)

- [x] Install npm dependencies (resend, react-email)
- [x] Phase 1: Database Schema Extension
- [x] Phase 2: Infrastructure (env config, queue client, email client)
- [x] Phase 3: Email Templates Module
- [x] Phase 4: Notification Delivery Module (core types, ports, usecases)
- [x] Phase 5: BullMQ Workers (collect, compose, send)
- [x] Phase 6: Manual Trigger Endpoint
- [x] Phase 7: Resend Webhook Ingestion
- [x] Phase 8: Extend Unsubscribe Endpoint (one-click support)
- [x] Phase 9: Stuck Sending Recovery
- [x] Phase 10: Integration & Wiring in build-app.ts
- [~] Phase 11: Testing - Unit tests for delivery repos
- [ ] Phase 11: Testing - Unit tests for webhook routes
- [ ] Phase 11: Testing - Unit tests for recover-stuck-sending

---

### IMPL: Added 1 new task(s)

**Time**: 2026-01-14T19:45:26Z
**Source**: TodoWrite
**Score**: 3
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T194526Z-TodoWrite-68177-tasks
**Tasks**: 15 (14 done, 1 active, 0 pending)

- [x] Install npm dependencies (resend, react-email)
- [x] Phase 1: Database Schema Extension
- [x] Phase 2: Infrastructure (env config, queue client, email client)
- [x] Phase 3: Email Templates Module
- [x] Phase 4: Notification Delivery Module (core types, ports, usecases)
- [x] Phase 5: BullMQ Workers (collect, compose, send)
- [x] Phase 6: Manual Trigger Endpoint
- [x] Phase 7: Resend Webhook Ingestion
- [x] Phase 8: Extend Unsubscribe Endpoint (one-click support)
- [x] Phase 9: Stuck Sending Recovery
- [x] Phase 10: Integration & Wiring in build-app.ts
- [x] Phase 11: Testing - Unit tests for delivery repos
- [x] Phase 11: Testing - Unit tests for webhook event repo
- [x] Phase 11: Testing - Unit tests for recover-stuck-sending
- [~] Run full test suite and type check

---

### PROMPT: User input

**Time**: 2026-01-14T19:49:43Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T194943Z-UserPrompt-87517

Write the specification file for the nofitication module

---

### PROMPT: User input

**Time**: 2026-01-14T19:53:11Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T195311Z-UserPrompt-1393

Now, add the script to package.json to test the live preview template.

---

### PROMPT: User input

**Time**: 2026-01-14T19:55:49Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T195549Z-UserPrompt-20223

Blank screen. Please review

---

### PROMPT: User input

**Time**: 2026-01-14T19:58:50Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T195850Z-UserPrompt-32648

I want you to use a beautiful design for it. Plan what information to include using the current data we have on the different modules and think what will be a very good design and information to include in the entity newsletter email.

---

### USER: Sections

**Time**: 2026-01-14T20:05:24Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T200524Z-AskUserQuestion-62187-q1
**Context**: Sections
**Multi-select**: false

**Question**: Which sections should I include in the redesigned email?

**Options**:

1. **All proposed sections (Recommended)** - Entity info + 3 metrics + % change + top 5 categories + funding sources + dual CTAs
2. **Core sections only** - Entity info + 3 metrics with % change indicators + single CTA (simpler, faster)
3. **Custom selection** - Let me specify which sections I want

**Selected**: All proposed sections (Recommended)

---

### USER: Data layer

**Time**: 2026-01-14T20:05:24Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T200524Z-AskUserQuestion-62187-q2
**Context**: Data layer
**Multi-select**: false

**Question**: Should I also update the data fetching logic to provide the additional data?

**Options**:

1. **Yes, full implementation (Recommended)** - Update compose-delivery use case to fetch top categories, funding sources, previous period comparison
2. **Template only** - Only redesign the email template, use mock/optional data for new sections

**Selected**: Yes, full implementation (Recommended)

---

### PLAN: Entity Newsletter Email Template Redesign Plan

**Time**: 2026-01-14T20:10:11Z
**Source**: ExitPlanMode
**Score**: 4
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T201011Z-ExitPlanMode-79487-plan
**Plan created**: 2026-01-14T22:05:46Z
**Lines**: 319
**Approved in**: /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-server

**Files**:

- Original: /Users/claudiuconstantinbogdan/.claude/plans/lively-wishing-yeti.md
- Archived: .claude/plans/archived/lively-wishing-yeti-20260114T201011Z.md
- Archived (full): /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-server/.claude/plans/archived/lively-wishing-yeti-20260114T201011Z.md

**Summary**:
• **Extend NewsletterEntityProps** with entity metadata, period comparisons, top expense categories, and funding source breakdowns; add reusable email components (metric cards, progress bars, category lists) matching client design aesthetics.

• **Redesign newsletter-entity.tsx template** to include 8 sections: header, entity info card, 3-column financial summary, period comparison, top 5 spending categories, funding sources breakdown, and CTAs—all styled with client color palette and responsive email-safe HTML tables.

• **Enhance data fetching layer** in compose-delivery use case to fetch top categories, funding source breakdown, and previous period data via new repository methods; update tests and i18n translations for new content.

---

### IMPL: Initial task breakdown

**Time**: 2026-01-14T20:10:28Z
**Source**: TodoWrite
**Score**: 3
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260114T201028Z-TodoWrite-81362-tasks
**Tasks**: 8 (0 done, 1 active, 7 pending)

- [~] Step 1: Extend types in email-templates/core/types.ts
- [ ] Step 2: Update i18n translations
- [ ] Step 3: Create reusable email components
- [ ] Step 4: Redesign main newsletter-entity template
- [ ] Step 5: Update data fetching in compose-delivery
- [ ] Step 6: Add repository methods for newsletter data
- [ ] Step 7: Update preview props with sample data
- [ ] Step 8: Run tests and verify in preview

---

### PROMPT: User input

**Time**: 2026-01-15T09:28:02Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 523dd2ea-06cd-4158-9fd2-36bb956b61f7-20260115T092802Z-UserPrompt-47321

/commit

---
